name: BuildNNCP

on: push

jobs:
  generate_version_number:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ github.ref == 'refs/heads/master' && steps.buildnumber.outputs.build_number || 1 }}
    steps:
      - name: Generate build number
        if: github.ref == 'refs/heads/master'
        id: buildnumber
        uses: onyxmueller/build-tag-number@v1
        with:
          token: ${{secrets.GITHUB_TOKEN}}

  build_linux:
    needs: generate_version_number
    runs-on: ubuntu-latest
    steps:
      - name: Download NNCP source
        run: wget https://bellard.org/nncp/nncp-2023-10-21.tar.gz -O nncp.tar.gz
      - name: Extract NNCP source
        run: tar xzf nncp.tar.gz
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential autoconf automake libtool
      - name: Prepare
        run: ./configure
        working-directory: ./nncp-2023-10-21
      - name: Build
        run: make
        working-directory: ./nncp-2023-10-21
      - uses: actions/upload-artifact@v4
        with:
          name: nncp-linux
          path: |
            ./nncp-2023-10-21/src/nncp

  build_windows:
    needs: generate_version_number
    runs-on: windows-latest
    steps:
      - name: Download NNCP source
        run: curl -L https://bellard.org/nncp/nncp-2023-10-21.tar.gz -o nncp.tar.gz
        shell: powershell
      - name: Extract NNCP source
        run: tar xzf nncp.tar.gz
        shell: bash
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            gcc
            make
            autoconf
            automake
            libtool
      - name: Prepare
        run: ./configure
        shell: msys2 {0}
        working-directory: ./nncp-2023-10-21
      - name: Build
        run: make
        shell: msys2 {0}
        working-directory: ./nncp-2023-10-21
      - uses: actions/upload-artifact@v4
        with:
          name: nncp-windows
          path: |
            ./nncp-2023-10-21/src/nncp.exe

  create_release:
    needs: [build_linux, build_windows]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts/
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{needs.generate_version_number.outputs.build_number}}
          release_name: Release ${{needs.generate_version_number.outputs.build_number}}
          draft: false
          prerelease: false
      - name: Upload Release Asset (Linux)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/nncp-linux
          asset_name: nncp-linux
          asset_content_type: application/octet-stream
      - name: Upload Release Asset (Windows)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/nncp-windows
          asset_name: nncp-windows
          asset_content_type: application/octet-stream
